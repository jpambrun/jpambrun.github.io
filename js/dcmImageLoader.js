/*
 jpxTest 2015-02-21 
*/
var cornerstoneDCMJ2KImageLoader=function(a,b,c){function d(c){for(var d,e=a.Deferred(),f=parseImageId(c),g=f.requestedQuality-1;g>=1&&void 0===d;g--)d=b.imageCache.getImagePromise(f.scheme+":"+f.url+"?quality="+g);i[c]=e;var l=k.indexOf(!0);if(void 0!==d)d.then(function(a){b.imageCache.removeImagePromise(a.imageId);var d=new Uint8Array(a.getDcmData()),e={imageId:c,parsedDicomData:a.parsedDicomData,oldDcmData:d};-1===l?j.unshift(e):(e.workerId=l,k[l]=!1,h[l].postMessage(e,[d.buffer]))});else{var m={imageId:c};-1===l?j.push(m):(m.workerId=l,k[l]=!1,h[l].postMessage(m))}return e}function e(a){var c=new Int16Array(a.data.pixelData),d=new Uint8Array(a.data.dcmData),e=a.data.width,f=a.data.height,l=a.data.imageId,m=a.data.loadedLayers,n=a.data.parsedDicomData,o=(parseImageId(l),{imageId:l,minPixelValue:-1100,maxPixelValue:2500,windowCenter:-600,windowWidth:1600,render:b.renderGrayscaleImage,getDcmData:function(){return d},getPixelData:function(){return c},rows:e,columns:f,height:f,width:e,color:!1,columnPixelSpacing:.8984375,rowPixelSpacing:.8984375,slope:n.rescaleSlope,intercept:n.rescaleIntercept,sizeInBytes:d.length+2*c.length,loadedLayers:m,parsedDicomData:n});void 0!==g&&g(a.data.stats);var p=i[l];if(delete i[l],0!==j.length){var q=j.shift();q.workerId=a.data.workerId,q.hasOwnProperty("oldDcmData")?h[a.data.workerId].postMessage(q,[q.oldDcmData.buffer]):h[a.data.workerId].postMessage(q)}else k[a.data.workerId]=!0;p.resolve(o)}function f(a){g=a}void 0===c&&(c={});var g,h,i={},j=[],k=[],l=8;if(void 0===h){h=[];for(var m=0;l>m;m++)h[m]=new Worker("js/dcmdlworker.js"),h[m].onmessage=e,k[m]=!0}return b.registerImageLoader("dcmj2k",d),c.setProgressCallback=f,c}($,cornerstone,cornerstoneDCMJ2KImageLoader);