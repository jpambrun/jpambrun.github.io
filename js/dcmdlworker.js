/*
 jpxTest 2015-02-20 
*/
"use strict";importScripts("jpx.js","util.js","utils.js","arithmetic_decoder.js","dicomparser.js");var jpxImage=new JpxImage,prefetchSize=2e4;self.onmessage=function(a){var b,c,d,e,f,g,h,i,j,k=a.data.imageId,l=parseImageId(k);if(void 0===a.data.oldDcmData){console.log("dl data : "+l.url),g=new XMLHttpRequest;var m=Date.now();if(g.open("GET",l.url,!1),g.setRequestHeader("Range","bytes=0-"+(prefetchSize-1)),g.responseType="arraybuffer",g.send(),200!==g.status&&206!==g.status)throw Error(g.status+" "+g.statusText+": "+l.url);h=new Uint8Array(g.response);for(var n,o=dicomParser.parseDicom(h),p=1;3>p||0!==o.uint32("x0069101"+(p+1));p++)n=p;if(c={patientName:o.string("x00100020"),rescaleIntercept:o.floatString("x00281052"),rescaleSlope:o.floatString("x00281053"),sliceLocation:o.floatString("x00201041"),numberOfLayers:n,imageBaseOffset:o.elements.x7fe00010.dataOffset+16,layers:[o.uint32("x00691012"),o.uint32("x00691013"),o.uint32("x00691014")]},void 0!==o.elements.x00691011){var q=c.layers[l.requestedQuality-1];f=c.imageBaseOffset+q}else f=c.imageBaseOffset+o.elements.x7fe00010.length-16;if(f>h.length){if(g=new XMLHttpRequest,g.open("GET",l.url,!1),g.responseType="arraybuffer",g.setRequestHeader("Range","bytes="+prefetchSize+"-"+f),g.send(),206!==g.status)throw Error(g.status+" "+g.statusText+": "+l.url);j=new Uint8Array(g.response),i=new Uint8Array(h.length+j.length),i.set(h,0),i.set(j,h.length),h=i}var r=Date.now();e=r-m,d=h.subarray(c.imageBaseOffset,f),b=1}else{c=a.data.parsedDicomData,console.log("update data : "+l.url);var s=new Uint8Array(a.data.oldDcmData);if(f=c.imageBaseOffset+c.layers[l.requestedQuality-1],g=new XMLHttpRequest,g.open("GET",l.url,!1),g.responseType="arraybuffer",g.setRequestHeader("Range","bytes="+s.length+"-"+f),g.send(),206!==g.status)throw Error(g.status+" "+g.statusText+": "+l.url);j=new Uint8Array(g.response),h=new Uint8Array(s.length+j.length),h.set(s,0),h.set(j,s.length),d=h.subarray(c.imageBaseOffset,f),b=l.requestedQuality}var t=Date.now();jpxImage.parse(d);var u=Date.now(),v=u-t,w=Math.round(d.length/1024),x=jpxImage.width,y=jpxImage.height,z=(jpxImage.componentsCount,jpxImage.tiles.length,jpxImage.tiles[0]),A=z.items;self.postMessage({workerId:a.data.workerId,pixelData:A.buffer,dcmData:h.buffer,width:x,height:y,fileSize:w,decodeTime:v,downloadTime:e,imageId:k,parsedDicomData:c,loadedLayers:b},[A.buffer,h.buffer])};