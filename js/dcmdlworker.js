/*
 jpxTest 2015-02-21 
*/
"use strict";importScripts("jpx.js","util.js","utils.js","arithmetic_decoder.js","dicomparser.js");var jpxImage=new JpxImage,prefetchSize=2e4;self.onmessage=function(a){var b,c,d,e,f,g,h,i,j,k,l=a.data.imageId,m=parseImageId(l),n={downloadTime:0,dicomParseTime:0,j2kDecodeTime:0,fileSize:0,isUpdate:0/0};if(void 0===a.data.oldDcmData){if(n.isUpdate=!1,j=Date.now(),f=new XMLHttpRequest,f.open("GET",m.url,!1),f.setRequestHeader("Range","bytes=0-"+(prefetchSize-1)),f.responseType="arraybuffer",f.send(),200!==f.status&&206!==f.status)throw Error(f.status+" "+f.statusText+": "+m.url);k=Date.now(),n.downloadTime+=k-j,n.fileSize=f.response.byteLength,g=new Uint8Array(f.response),j=Date.now();for(var o,p=dicomParser.parseDicom(g),q=1;3>q||0!==p.uint32("x0069101"+(q+1));q++)o=q;if(c={patientName:p.string("x00100020"),rescaleIntercept:p.floatString("x00281052"),rescaleSlope:p.floatString("x00281053"),sliceLocation:p.floatString("x00201041"),numberOfLayers:o,imageBaseOffset:p.elements.x7fe00010.dataOffset+16,layers:[p.uint32("x00691012"),p.uint32("x00691013"),p.uint32("x00691014")]},void 0!==p.elements.x00691011){var r=c.layers[m.requestedQuality-1];e=c.imageBaseOffset+r}else e=c.imageBaseOffset+p.elements.x7fe00010.length-16;if(k=Date.now(),n.dicomParseTime+=k-j,e>g.length){if(j=Date.now(),f=new XMLHttpRequest,f.open("GET",m.url,!1),f.responseType="arraybuffer",f.setRequestHeader("Range","bytes="+prefetchSize+"-"+e),f.send(),206!==f.status)throw Error(f.status+" "+f.statusText+": "+m.url);k=Date.now(),n.downloadTime+=k-j,n.fileSize+=f.response.byteLength,i=new Uint8Array(f.response),h=new Uint8Array(g.length+i.length),h.set(g,0),h.set(i,g.length),g=h}d=g.subarray(c.imageBaseOffset,e),b=1}else{n.isUpdate=!0,c=a.data.parsedDicomData;var s=new Uint8Array(a.data.oldDcmData);if(e=c.imageBaseOffset+c.layers[m.requestedQuality-1],j=Date.now(),f=new XMLHttpRequest,f.open("GET",m.url,!1),f.responseType="arraybuffer",f.setRequestHeader("Range","bytes="+s.length+"-"+e),f.send(),206!==f.status)throw Error(f.status+" "+f.statusText+": "+m.url);k=Date.now(),n.downloadTime+=k-j,n.fileSize=f.response.byteLength,i=new Uint8Array(f.response),g=new Uint8Array(s.length+i.length),g.set(s,0),g.set(i,s.length),d=g.subarray(c.imageBaseOffset,e),b=m.requestedQuality}j=Date.now(),jpxImage.parse(d),k=Date.now(),n.j2kDecodeTime+=k-j;var t=jpxImage.width,u=jpxImage.height,v=(jpxImage.componentsCount,jpxImage.tiles.length,jpxImage.tiles[0]),w=v.items;self.postMessage({workerId:a.data.workerId,pixelData:w.buffer,dcmData:g.buffer,width:t,height:u,imageId:l,parsedDicomData:c,loadedLayers:b,stats:n},[w.buffer,g.buffer])};