/*
 jpxTest 2015-02-21 
*/
"use strict";importScripts("jpx.js","util.js","utils.js","arithmetic_decoder.js","dicomparser.js");var jpxImage=new JpxImage,prefetchSize=2e4;self.onmessage=function(a){var b,c,d,e,f,g,h,i,j,k,l=a.data.imageId,m=parseImageId(l),n={downloadTime:0,dicomParseTime:0,j2kDecodeTime:0,fileSize:0,isUpdate:0/0};if(void 0===a.data.oldDcmData){if(n.isUpdate=!1,j=Date.now(),f=new XMLHttpRequest,f.open("GET",m.url,!1),f.setRequestHeader("Range","bytes=0-"+(prefetchSize-1)),f.responseType="arraybuffer",f.send(),200!==f.status&&206!==f.status)throw Error(f.status+" "+f.statusText+": "+m.url);k=Date.now(),n.downloadTime+=k-j,n.fileSize=f.response.byteLength,g=new Uint8Array(f.response),j=Date.now();var o=dicomParser.parseDicom(g);if(c={patientName:o.string("x00100020"),rescaleIntercept:o.floatString("x00281052"),rescaleSlope:o.floatString("x00281053"),sliceLocation:o.floatString("x00201041"),numberOfLayers:1,imageBaseOffset:o.elements.x7fe00010.dataOffset+16,layers:[]},void 0!==o.elements.x00691011){for(var p=1;3>p||0!==o.uint32("x0069101"+(p+1));p++)c.numberOfLayers=p;c.layers=[o.uint32("x00691012"),o.uint32("x00691013"),o.uint32("x00691014")];var q=c.layers[m.requestedQuality-1];e=c.imageBaseOffset+q}else e=1/0;if(k=Date.now(),n.dicomParseTime+=k-j,e>g.length){if(j=Date.now(),f=new XMLHttpRequest,f.open("GET",m.url,!1),f.responseType="arraybuffer",isFinite(e)?f.setRequestHeader("Range","bytes="+prefetchSize+"-"+e):f.setRequestHeader("Range","bytes="+prefetchSize+"-"),f.send(),206!==f.status)throw Error(f.status+" "+f.statusText+": "+m.url);k=Date.now(),n.downloadTime+=k-j,n.fileSize+=f.response.byteLength,i=new Uint8Array(f.response),h=new Uint8Array(g.length+i.length),h.set(g,0),h.set(i,g.length),g=h}d=g.subarray(c.imageBaseOffset,e),b=1}else{n.isUpdate=!0,c=a.data.parsedDicomData;var r=new Uint8Array(a.data.oldDcmData);if(e=c.imageBaseOffset+c.layers[m.requestedQuality-1],j=Date.now(),f=new XMLHttpRequest,f.open("GET",m.url,!1),f.responseType="arraybuffer",f.setRequestHeader("Range","bytes="+r.length+"-"+e),f.send(),206!==f.status)throw Error(f.status+" "+f.statusText+": "+m.url);k=Date.now(),n.downloadTime+=k-j,n.fileSize=f.response.byteLength,i=new Uint8Array(f.response),g=new Uint8Array(r.length+i.length),g.set(r,0),g.set(i,r.length),d=g.subarray(c.imageBaseOffset,e),b=m.requestedQuality}j=Date.now(),jpxImage.parse(d),k=Date.now(),n.j2kDecodeTime+=k-j;var s=jpxImage.width,t=jpxImage.height,u=(jpxImage.componentsCount,jpxImage.tiles.length,jpxImage.tiles[0]),v=u.items;self.postMessage({workerId:a.data.workerId,pixelData:v.buffer,dcmData:g.buffer,width:s,height:t,imageId:l,parsedDicomData:c,loadedLayers:b,stats:n},[v.buffer,g.buffer])};